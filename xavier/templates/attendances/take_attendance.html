{% extends "attendances/base.html" %}

{% load attendances_tags %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block extrahead %}
<script type="text/javascript">
  function toggleAttendance(studentId) {
    var data = "attendance_book=" + {{ attendance_book.pk }} + "&student=" + studentId;
    $.ajax({
      url: "{% url 'attendances_attendancebook_ajax_toggle_attendance' %}",
      method: "GET",
      data: data,
      cache: false
    });
    return false;
  }

  function toggleLateStatus(studentId) {
    var data = "attendance_book=" + {{ attendance_book.pk }} + "&student=" + studentId;
    $.ajax({
      url: "{% url 'attendances_attendancebook_ajax_toggle_late_status' %}",
      method: "GET",
      data: data,
      cache: false
    });
    return false;
  }

  $(document).ready(function () {
    $('.switch').on('switch-change', function(e, data) {
      // TODO: switch only if success!
      var $el = $(data.el),
          attendee = data.value,
          studentId = $el[0].value;

      toggleAttendance(studentId);

      $lateButton = $('#late-' + studentId);
      $lateButton.toggleClass('disabled');
      if ($lateButton.hasClass('active'))
        $lateButton.removeClass('active');
    });
  });
</script>
{% endblock %}

{% block breadcrumb %}{{ block.super }}
  <li>
    <a href="{% url 'attendances_attendancebook_list' %}">{% trans 'Attendance books' %}</a>
    <span class="divider">/</span>
  </li>
  <li class="active">{% trans 'Take attendance' %}</li>
{% endblock %}

{% block main %}
<form class="form-horizontal" action=".">
  <span class="input-append">
    <input class="input-medium" type="date" name="day" value="{{ attendance_book.day|date:'Y-m-d' }}" />
    <button class="btn btn-primary" type="submit" title="{% trans 'Change date' %}">
      &nbsp;<i class="icon-white icon-refresh"></i>&nbsp;
    </button>
  </span>
  <a class="btn" href="." title="{% trans 'Show today' %}">{% trans 'today'|capfirst %}</a>
</form>

<table class="table table-striped">
  <tr>
    <th>#</th>
    <th>{% trans 'student'|capfirst %}</th>
    <th>{% trans 'status'|capfirst %}</th>
  </tr>
  {% for student in classroom.students.all %}
  <tr>
    <td>{{ student.id }}</td>
    <td>{{ student.get_full_name }}</td>
    <td>
      <div class="switch" data-on="success" data-off="danger"
           data-on-label="P" data-off-label="A">
        <input type="checkbox" value="{{ student.pk }}"
               {% if student in attendance_book.students.all %}checked{% endif %}/>
      </div>
      <button class="btn{% if student|is_late:attendance_book == None %} disabled{% elif student|is_late:attendance_book %} active{% endif %}" id="late-{{ student.id }}" type="button" data-toggle="button" onclick="toggleLateStatus({{ student.pk }})"><i class="icon icon-time"></i> {% trans 'Late' %}</button>
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}
