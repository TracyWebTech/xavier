{% extends "attendances/base.html" %}

{% load attendances_tags %}

{% block title %}{{ title }} - {{ block.super }}{% endblock %}

{% block extrahead %}
<script type="text/javascript">
  function toggleAttendance(studentId, successCallback) {
    var data = "attendance_book=" + {{ attendance_book.pk }} + "&student=" + studentId;
    $.ajax({
      url: "{% url 'attendances_attendancebook_ajax_toggle_attendance' %}",
      method: "GET",
      data: data,
      cache: false,
      success: function (){
        if (successCallback) successCallback(studentId);
      }
    });
    return false;
  }

  function toggleLateStatusAjax(studentId) {
    var data = "attendance_book=" + {{ attendance_book.pk }} + "&student=" + studentId;
    $.ajax({
      url: "{% url 'attendances_attendancebook_ajax_toggle_late_status' %}",
      method: "GET",
      data: data,
      cache: false
    });
  }

  function toggleLateStatus(studentId) {

    $attendance = $('.switch input[value="'+ studentId +'"]');
    $lateButton = $('#late-' + studentId);

    if ($lateButton.hasClass('btn-warning')) {
      $lateButton.removeClass('btn-warning');
      $attendance.attr('data-is-late', false);
    } else {
      $lateButton.addClass('btn-warning');
      $attendance.attr('data-is-late', true);
    }

    if ($attendance.is(':checked')) {
      toggleLateStatusAjax(studentId);
    } else {
      $attendance.parent().bootstrapSwitch('toggleState');
    }

    return false;
  }

  $(document).ready(function () {
    $('.switch').on('switch-change', function(e, data) {
      // TODO: switch only if success!
      var $el = $(data.el),
          attendee = data.value,
          studentId = $el[0].value,
          isLate = $el.attr('data-is-late');

      toggleAttendanceCallBack = false;
      if ($el.is(':checked') && isLate) {
        toggleAttendanceCallBack = toggleLateStatusAjax;
      }
      else if ($el.is(':not(:checked)')) {
        $('#late-' + studentId).removeClass('active btn-warning');
      }

      toggleAttendance(studentId, toggleAttendanceCallBack);
    });

    $('input[name="day"]').on('change', function(event) {
        $(event.target).closest('form').submit();
    });
  });
</script>
{% endblock %}

{% block breadcrumb %}{{ block.super }}
  <li>
    <a href="{% url 'attendances_attendancebook_list' %}">{% trans 'Attendance' %}</a>
    <span class="divider">/</span>
  </li>
  <li class="active">{{ classroom }}</li>
{% endblock %}

{% block main %}
<form class="form-horizontal" action=".">
  <span class="input-append">
    <input class="input-medium" type="date" name="day" value="{{ attendance_book.day|date:'Y-m-d' }}" />
    <button class="btn btn-primary" type="submit" title="{% trans 'Change date' %}">
      &nbsp;<i class="icon-white icon-refresh"></i>&nbsp;
    </button>
  </span>
  <a class="btn" href="." title="{% trans 'Show today' %}">{% trans 'today'|capfirst %}</a>
</form>

<table class="table table-striped">
  <tr>
    <th>#</th>
    <th>{% trans 'student'|capfirst %}</th>
    <th>{% trans 'status'|capfirst %}</th>
    <th>{% trans 'late'|capfirst %}</th>
  </tr>
  {% for student in classroom.students.all %}
  <tr>
    <td>{{ student.id }}</td>
    <td>{{ student.get_full_name }}</td>
    <td>
      <div class="switch" data-on="success" data-off="danger"
           data-on-label="P" data-off-label="A">
        <input type="checkbox" value="{{ student.pk }}"
               {% if student in attendance_book.students.all %}checked{% endif %}/>
      </div>
    </td>
    <td>
      <button class="btn btn-large late{% if student|is_late:attendance_book %} active btn-warning{% endif %}" id="late-{{ student.id }}" type="button" data-toggle="button" onclick="toggleLateStatus({{ student.pk }})"><i class="icon icon-warning-sign"></i></button>
    </td>
  </tr>
  {% endfor %}
</table>
{% endblock %}
